---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProductGrid from '../components/ProductGrid.astro';
import {
  PRODUCT_CATEGORIES,
  type ProductQuery,
  getFilteredProducts,
  getTagsByCategory,
  type Product,
} from '../lib/products';

const url = new URL(Astro.request.url);

const activeCategory = PRODUCT_CATEGORIES.find(
  (category) => category.key === url.searchParams.get('category')
)?.key;
const activeTag = url.searchParams.get('tag') || undefined;
const sort = (url.searchParams.get('sort') || 'newest') as ProductQuery['sort'];
const orbMin = url.searchParams.get('orbMin') ? Number(url.searchParams.get('orbMin')) : undefined;
const orbMax = url.searchParams.get('orbMax') ? Number(url.searchParams.get('orbMax')) : undefined;

const products: Product[] = await getFilteredProducts({
  category: activeCategory,
  tag: activeTag,
  sort,
  orbMin,
  orbMax,
});
const tags = await getTagsByCategory(activeCategory);

const sortOptions: { value: ProductQuery['sort']; label: string }[] = [
  { value: 'newest', label: '新規出品順' },
  { value: 'price-high', label: '価格が高い順' },
  { value: 'price-low', label: '価格が安い順' },
  { value: 'orb-high', label: 'オーブが多い順' },
  { value: 'orb-low', label: 'オーブが少ない順' },
];

const buildFilterUrl = (params: Record<string, string | undefined>) => {
  const next = new URLSearchParams(url.searchParams);
  Object.entries(params).forEach(([key, value]) => {
    if (!value) {
      next.delete(key);
      return;
    }
    next.set(key, value);
  });

  return `/?${next.toString()}`;
};
---

<BaseLayout title="モンスト商品一覧" description="オーブアカウント・代行・強垢をカテゴリで探せます">
  <div class="container">
    <section class="hero">
      <h1>モンスト販売マーケット</h1>
      <p>アカウント販売（オーブアカウント）・代行・強垢販売をカテゴリごとに絞り込みできます</p>
    </section>

    <section class="category-tabs" aria-label="カテゴリ選択">
      <a href="/" class:list={['tab', { active: !activeCategory }]}>すべて</a>
      {PRODUCT_CATEGORIES.map((category) => (
        <a
          href={buildFilterUrl({ category: category.key, tag: undefined })}
          class:list={['tab', { active: activeCategory === category.key }]}
        >
          {category.label}
        </a>
      ))}
    </section>

    <section class="filters-panel">
      <form method="get" class="filters-form">
        {activeCategory && <input type="hidden" name="category" value={activeCategory} />}
        {activeTag && <input type="hidden" name="tag" value={activeTag} />}

        <label>
          並び順
          <select name="sort">
            {sortOptions.map((option) => (
              <option value={option.value} selected={sort === option.value}>
                {option.label}
              </option>
            ))}
          </select>
        </label>

        <label>
          オーブ数（下限）
          <input type="number" name="orbMin" min="0" value={orbMin ?? ''} placeholder="例: 300" />
        </label>

        <label>
          オーブ数（上限）
          <input type="number" name="orbMax" min="0" value={orbMax ?? ''} placeholder="例: 2000" />
        </label>

        <button class="btn btn-primary" type="submit">絞り込む</button>
      </form>

      {tags.length > 0 && (
        <nav class="tag-filter" aria-label="サブカテゴリ">
          <a href={buildFilterUrl({ tag: undefined })} class:list={['tag-item', { active: !activeTag }]}>すべて</a>
          {tags.map(({ tag, count }) => (
            <a
              href={buildFilterUrl({ tag })}
              class:list={['tag-item', { active: activeTag === tag }]}
            >
              {tag} <span>({count})</span>
            </a>
          ))}
        </nav>
      )}
    </section>

    <section class="products">
      <ProductGrid products={products} />
    </section>
  </div>
</BaseLayout>

<style>
  .hero { text-align: center; padding: 2rem 0; }
  .hero p { color: var(--color-text-muted); }

  .category-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .tab {
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    border-radius: 9999px;
    padding: 0.5rem 1rem;
    color: var(--color-text-muted);
  }

  .tab.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: #fff;
  }

  .filters-panel {
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
    align-items: end;
  }

  .filters-form label {
    display: grid;
    gap: 0.25rem;
    font-size: 0.875rem;
  }

  .filters-form input,
  .filters-form select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: calc(var(--radius) / 2);
    background: var(--color-bg);
    color: var(--color-text);
  }

  .tag-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .tag-item {
    font-size: 0.8125rem;
    border: 1px solid var(--color-border);
    border-radius: 9999px;
    padding: 0.25rem 0.75rem;
    color: var(--color-text-muted);
  }

  .tag-item.active {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .products {
    padding-bottom: 3rem;
  }
</style>
